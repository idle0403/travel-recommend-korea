<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>🇰🇷 스마트 한국 여행 플래너</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>🇰🇷</text></svg>">
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <!-- Header -->
        <div class="text-center mb-8">
            <div class="flex justify-between items-center mb-4">
                <div></div>
                <!-- 🆕 로컬 히스토리 버튼 (로그인 불필요) -->
                <div class="space-x-2">
                    <button onclick="showHistory()" class="px-4 py-2 text-blue-600 border border-blue-600 rounded hover:bg-blue-50">
                        <i class="fas fa-history mr-1"></i>내 여행 기록 (<span id="historyCount">0</span>)
                    </button>
                    <button onclick="clearHistory()" class="px-3 py-2 text-red-600 border border-red-600 rounded hover:bg-red-50">
                        <i class="fas fa-trash mr-1"></i>전체 삭제
                    </button>
                </div>
                <div></div>
            </div>
            <h1 class="text-4xl font-bold text-gray-800 mb-2">🇰🇷 스마트 한국 여행 플래너</h1>
            <p class="text-gray-600">AI가 추천하는 맞춤형 한국 여행 계획 (로컬 전용, 로그인 불필요)</p>
        </div>

        <!-- Main Form -->
        <div class="max-w-4xl mx-auto bg-white rounded-lg shadow-lg p-6 mb-8">
            <form id="travelForm" class="space-y-6">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            <i class="fas fa-map-marker-alt text-red-500"></i> 여행 도시 (선택사항)
                            <span class="text-xs text-gray-500 ml-2">💡 프롬프트에서 자동 인식됩니다</span>
                        </label>
                        <select id="city" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                            <option value="Auto">🤖 자동 인식 (프롬프트에서 추출)</option>
                            <optgroup label="특별시">
                                <option value="Seoul">서울특별시</option>
                            </optgroup>
                            <optgroup label="광역시">
                                <option value="Busan">부산광역시</option>
                                <option value="Daegu">대구광역시</option>
                                <option value="Incheon">인천광역시</option>
                                <option value="Gwangju">광주광역시</option>
                                <option value="Daejeon">대전광역시</option>
                                <option value="Ulsan">울산광역시</option>
                            </optgroup>
                            <optgroup label="특별자치도">
                                <option value="Jeju">제주특별자치도</option>
                            </optgroup>
                            <optgroup label="경기도">
                                <option value="Suwon">수원시</option>
                                <option value="Yongin">용인시</option>
                                <option value="Seongnam">성남시</option>
                                <option value="Goyang">고양시</option>
                            </optgroup>
                            <optgroup label="강원도">
                                <option value="Chuncheon">춘천시</option>
                                <option value="Gangneung">강릉시</option>
                                <option value="Sokcho">속초시</option>
                            </optgroup>
                            <optgroup label="충청북도">
                                <option value="Cheongju">청주시</option>
                                <option value="Chungju">충주시</option>
                            </optgroup>
                            <optgroup label="충청남도">
                                <option value="Cheonan">천안시</option>
                                <option value="Gongju">공주시</option>
                                <option value="Buyeo">부여군</option>
                            </optgroup>
                            <optgroup label="전라북도">
                                <option value="Jeonju">전주시</option>
                                <option value="Gunsan">군산시</option>
                            </optgroup>
                            <optgroup label="전라남도">
                                <option value="Mokpo">목포시</option>
                                <option value="Yeosu">여수시</option>
                                <option value="Suncheon">순천시</option>
                            </optgroup>
                            <optgroup label="경상북도">
                                <option value="Pohang">포항시</option>
                                <option value="Gyeongju">경주시</option>
                                <option value="Andong">안동시</option>
                            </optgroup>
                            <optgroup label="경상남도">
                                <option value="Changwon">창원시</option>
                                <option value="Jinju">진주시</option>
                                <option value="Tongyeong">통영시</option>
                                <option value="Geoje">거제시</option>
                            </optgroup>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            <i class="fas fa-heart text-pink-500"></i> 여행 스타일
                        </label>
                        <select id="travelStyle" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                            <option value="indoor_date">💕 실내 데이트</option>
                            <option value="outdoor_date">🌳 실외 데이트</option>
                            <option value="food_tour">🍽️ 맛집 투어</option>
                            <option value="culture_tour">🏛️ 문화 탐방</option>
                            <option value="shopping_tour">🛍️ 쇼핑 투어</option>
                            <option value="healing_tour">🧘 힐링 여행</option>
                            <option value="adventure_tour">🎢 액티비티</option>
                            <option value="night_tour">🌃 야경 투어</option>
                            <option value="family_tour">👨‍👩‍👧‍👦 가족 여행</option>
                            <option value="custom">✨ 맞춤 설정</option>
                        </select>
                    </div>
                </div>

                <!-- 여행 기간 설정 -->
                <div id="customDateSection" class="space-y-4">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                <i class="fas fa-calendar-plus text-green-500"></i> 여행 시작
                            </label>
                            <div class="grid grid-cols-2 gap-2">
                                <input type="date" id="startDate" class="p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                <input type="time" id="startTime" value="09:00" class="p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                <i class="fas fa-calendar-minus text-red-500"></i> 여행 종료
                            </label>
                            <div class="grid grid-cols-2 gap-2">
                                <input type="date" id="endDate" class="p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                <input type="time" id="endTime" value="18:00" class="p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                            </div>
                        </div>
                    </div>
                    
                    <!-- 여행 기간 표시 -->
                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                        <div class="flex items-center space-x-2">
                            <i class="fas fa-info-circle text-blue-500"></i>
                            <span class="text-sm font-medium text-blue-800">여행 기간:</span>
                            <span id="tripDuration" class="text-sm text-blue-700">날짜를 선택해주세요</span>
                        </div>
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        <i class="fas fa-home text-orange-500"></i> 출발지 (집 주소)</span>
                    </label>
                    <div class="relative">
                        <input type="text" id="startLocation" placeholder="지도에서 출발지를 선택해주세요"
                               class="w-full p-3 border border-gray-300 rounded-lg bg-gray-50 cursor-pointer focus:ring-2 focus:ring-blue-500" readonly>
                        <button type="button" id="mapSearchBtn" class="absolute right-2 top-1/2 transform -translate-y-1/2 text-blue-500 hover:text-blue-700">
                            <i class="fas fa-map-marker-alt"></i>
                        </button>
                    </div>

                </div>

                <!-- 지도 선택 모달 (개선된 UI) -->
                <div id="mapModal" class="fixed inset-0 bg-black bg-opacity-60 z-50 hidden flex items-center justify-center p-4">
                    <div class="bg-white rounded-2xl shadow-2xl max-w-5xl w-full max-h-[90vh] flex flex-col">
                        <!-- 헤더 -->
                        <div class="flex justify-between items-center p-6 border-b border-gray-200">
                            <div>
                                <h3 class="text-2xl font-bold text-gray-800 flex items-center">
                                    <i class="fas fa-map-marker-alt text-blue-500 mr-3"></i>
                                    출발지 선택
                                </h3>
                                <p class="text-sm text-gray-500 mt-1">지도를 클릭하거나 검색하여 출발 위치를 선택하세요</p>
                            </div>
                            <button id="closeMapModal" class="text-gray-400 hover:text-gray-600 transition-colors p-2 hover:bg-gray-100 rounded-full">
                                <i class="fas fa-times text-xl"></i>
                            </button>
                        </div>
                        
                        <!-- 검색창 -->
                        <div class="p-6 pb-3">
                            <div class="relative">
                                <i class="fas fa-search absolute left-4 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                                <input type="text" id="mapSearchInput" 
                                       placeholder="예: 강남역, 서울역, 명동 등..."
                                       class="w-full pl-12 pr-4 py-3 border-2 border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all">
                            </div>
                        </div>
                        
                        <!-- 선택된 위치 표시 -->
                        <div id="selectedLocationInfo" class="px-6 pb-3 hidden">
                            <div class="bg-blue-50 border-l-4 border-blue-500 p-3 rounded-r-lg flex items-start">
                                <i class="fas fa-check-circle text-blue-500 mt-1 mr-3"></i>
                                <div class="flex-1">
                                    <p class="font-semibold text-blue-900 text-sm">선택된 위치</p>
                                    <p id="selectedLocationText" class="text-blue-700 text-sm mt-1"></p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 지도 -->
                        <div class="flex-1 px-6 pb-6 min-h-[400px]">
                            <div id="mapContainer" class="w-full h-full rounded-xl border-2 border-gray-200 shadow-inner"></div>
                        </div>
                        
                        <!-- 푸터 버튼 -->
                        <div class="flex justify-between items-center p-6 border-t border-gray-200 bg-gray-50 rounded-b-2xl">
                            <div class="text-xs text-gray-500">
                                <i class="fas fa-info-circle mr-1"></i>
                                지도를 클릭하거나 검색창에서 장소를 검색하세요
                            </div>
                            <div class="flex space-x-3">
                                <button id="cancelMapSelection" 
                                        class="px-6 py-2.5 text-gray-700 bg-white border-2 border-gray-300 rounded-lg hover:bg-gray-50 transition-all font-medium">
                                    <i class="fas fa-times mr-2"></i>취소
                                </button>
                                <button id="confirmMapSelection" 
                                        class="px-6 py-2.5 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-all font-medium shadow-lg hover:shadow-xl">
                                    <i class="fas fa-check mr-2"></i>선택 완료
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        <i class="fas fa-comment text-green-500"></i> 여행 요청사항
                        <span class="text-xs text-blue-600 ml-2">✨ 지역명을 포함하면 자동으로 해당 지역 정보를 수집합니다!</span>
                    </label>
                    <textarea id="prompt" rows="4" placeholder="예: 청도에서 맛집 위주로 가족 여행 계획을 세워주세요
예: 밀양 얼음골 근처에서 자연 여행
예: 합천 해인사 일대 문화 탐방

💡 전국 어디든 지역명만 입력하면 자동으로 정보를 수집합니다!"
                              class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"></textarea>
                    <div class="mt-2 text-xs text-gray-500">
                        <i class="fas fa-lightbulb text-yellow-500 mr-1"></i>
                        <strong>TIP:</strong> 청도, 밀양, 합천 등 소도시도 자동으로 지역 정보를 수집하여 추천합니다!
                    </div>
                </div>

                <button type="submit" id="submitBtn"
                        class="w-full bg-gradient-to-r from-blue-500 to-indigo-600 text-white py-3 px-6 rounded-lg hover:from-blue-600 hover:to-indigo-700 transition duration-300">
                    <i class="fas fa-magic mr-2"></i>
                    <span id="btnText">AI 여행 계획 생성</span>
                </button>
            </form>
        </div>

        <!-- Loading (🆕 실시간 로그 포함) -->
        <div id="loading" class="hidden max-w-2xl mx-auto">
            <div class="bg-white rounded-lg shadow-lg p-6">
                <div class="text-center mb-4">
                    <div class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-blue-500"></div>
                    <p class="mt-4 text-gray-800 font-medium">AI가 맞춤형 여행 계획을 생성하고 있습니다...</p>
                </div>
                <!-- 🆕 실시간 로그 -->
                <div class="bg-gray-50 rounded-lg p-4 max-h-96 overflow-y-auto">
                    <div id="progressLog" class="space-y-2 text-sm">
                        <div class="text-gray-500"><i class="fas fa-spinner fa-spin mr-2"></i>준비 중...</div>
                    </div>
                    <!-- 진행률 바 -->
                    <div class="mt-4">
                        <div class="w-full bg-gray-200 rounded-full h-2">
                            <div id="progressBar" class="bg-blue-500 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
                        </div>
                        <p class="text-xs text-gray-500 mt-1 text-center">
                            <span id="progressText">0%</span>
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Results -->
        <div id="results" class="hidden max-w-7xl mx-auto">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- Left Column: Timeline & Details -->
                <div class="space-y-6">
                    <!-- Timeline -->
                    <div class="bg-white rounded-lg shadow-lg p-6">
                        <h2 class="text-2xl font-bold text-gray-800 mb-4">
                            <i class="fas fa-clock text-blue-500"></i> 시간별 일정
                        </h2>
                        <!-- 일자별 탭 -->
                        <div id="dayTabs" class="flex flex-wrap mb-4 border-b hidden"></div>
                        <div id="timeline" class="space-y-4"></div>
                    </div>

                    <!-- Place Details -->
                    <div class="bg-white rounded-lg shadow-lg p-6">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">
                            <i class="fas fa-info-circle text-green-500"></i> 장소 상세정보
                        </h3>
                        <div id="placeDetails" class="space-y-4"></div>
                    </div>
                </div>

                <!-- Right Column: Map & Status -->
                <div class="space-y-6">
                    <!-- Map -->
                    <div class="bg-white rounded-lg shadow-lg p-6">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">
                            <i class="fas fa-map text-red-500"></i> 최적 동선
                        </h3>
                        <div class="mb-3 flex space-x-4 text-xs">
                            <div class="flex items-center">
                                <div class="w-4 h-1 bg-blue-500 mr-1"></div>
                                <span>🚇 대중교통</span>
                            </div>
                            <div class="flex items-center">
                                <div class="w-4 h-1 bg-red-500 mr-1"></div>
                                <span>🚗 자동차</span>
                            </div>
                            <div class="flex items-center">
                                <div class="w-4 h-1 bg-green-500 mr-1"></div>
                                <span>🚶 도보</span>
                            </div>
                        </div>
                        <div id="map" class="w-full h-96 rounded-lg"></div>
                        
                        <!-- 경로 선택 버튼 영역 -->
                        <div id="routeSection" class="mt-4 hidden">
                            <div class="border-t pt-4">
                                <h4 class="font-semibold text-gray-700 mb-3">🚗 경로 선택</h4>
                                <div id="routeButtons"></div>
                                <div id="routeDetails" class="mt-3 text-sm text-gray-600"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Weather Info -->
                    <div id="weatherInfo" class="bg-white rounded-lg shadow-lg p-6 hidden">
                        <h3 class="text-lg font-semibold text-gray-800 mb-3">
                            <i class="fas fa-cloud-sun text-blue-500"></i> 현재 날씨
                        </h3>
                        <div id="weatherContent" class="space-y-2"></div>
                    </div>

                    <!-- 저장 상태 (🆕 자동 저장) -->
                    <div class="bg-white rounded-lg shadow-lg p-6">
                        <h3 class="text-lg font-semibold text-gray-800 mb-3">
                            <i class="fas fa-save text-green-500"></i> 저장 상태
                        </h3>
                        <div class="space-y-3">
                            <!-- 🆕 자동 저장 안내 (로그인 불필요) -->
                            <div class="bg-green-50 border border-green-200 rounded p-4">
                                <div class="flex items-center space-x-2 mb-2">
                                    <i class="fas fa-check-circle text-green-600 text-xl"></i>
                                    <span class="text-sm text-green-800 font-bold">
                                        ✅ 브라우저에 자동 저장 완료!
                                    </span>
                                </div>
                                <p class="text-xs text-green-700 ml-8">
                                    상단 "내 여행 기록" 버튼을 클릭하여 언제든 확인하고 불러올 수 있습니다.
                                </p>
                                <p class="text-xs text-gray-500 ml-8 mt-1">
                                    💡 로그인 없이 최대 50개까지 저장됩니다.
                                </p>
                            </div>
                            
                            <!-- Notion 저장 (선택적) -->
                            <button id="saveNotionBtn" class="w-full bg-purple-500 text-white py-2 rounded hover:bg-purple-600">
                                <i class="fas fa-database mr-2"></i>Notion에도 저장 (선택)
                            </button>
                        </div>
                        <div id="saveResult" class="mt-3 hidden"></div>
                    </div>
                    
                    <!-- 예산 계산기 -->
                    <div class="bg-white rounded-lg shadow-lg p-6">
                        <h3 class="text-lg font-semibold text-gray-800 mb-3">
                            <i class="fas fa-calculator text-orange-500"></i> 예산 계산
                        </h3>
                        <div class="space-y-2">
                            <select id="budgetStyle" class="w-full p-2 border rounded">
                                <option value="budget">절약형</option>
                                <option value="moderate" selected>보통</option>
                                <option value="luxury">럭셔리</option>
                            </select>
                            <button id="calculateBudgetBtn" class="w-full bg-orange-500 text-white py-2 rounded hover:bg-orange-600">
                                예산 계산하기
                            </button>
                        </div>
                        <div id="budgetResult" class="mt-3 hidden"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Toast Notifications -->
        <div id="toast" class="fixed top-4 right-4 z-50 hidden">
            <div class="bg-white border-l-4 border-green-500 rounded-lg shadow-lg p-4 max-w-sm">
                <div class="flex items-center">
                    <i id="toastIcon" class="fas fa-check-circle text-green-500 mr-3"></i>
                    <span id="toastMessage" class="text-gray-800"></span>
                </div>
            </div>
        </div>

        <!-- Place Modal -->
        <div id="placeModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center">
            <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full mx-4 max-h-96 overflow-y-auto">
                <div class="p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h3 id="modalTitle" class="text-xl font-bold text-gray-800"></h3>
                        <button id="closeModal" class="text-gray-500 hover:text-gray-700">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div id="modalContent" class="space-y-4"></div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- ✅ script.js를 body 끝에서 로드 -->
    <script src="script.js"></script>
    <script>
        // DOM 로드 완료 후 Google Maps API 로드
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', loadGoogleMaps);
        } else {
            loadGoogleMaps();
        }
        
        function loadGoogleMaps() {
            console.log('Loading Google Maps API...');
            fetch('/api/travel/config')
                .then(response => response.json())
                .then(config => {
                    console.log('Config loaded:', config);
                    const script = document.createElement('script');
                    script.src = `https://maps.googleapis.com/maps/api/js?key=${config.google_maps_api_key}&libraries=places,geometry&callback=initializeApp`;
                    script.onerror = () => console.error('Google Maps API 로드 실패');
                    document.head.appendChild(script);
                })
                .catch(error => console.error('API 키 로드 실패:', error));
        }
    </script>
</body>
</html>