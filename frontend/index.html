<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ‡°ğŸ‡· ìŠ¤ë§ˆíŠ¸ í•œêµ­ ì—¬í–‰ í”Œë˜ë„ˆ</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCVse3Cxbje1YzMp_SB6dkMvaWfCpMQ3Mk&libraries=places,geometry"></script>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <!-- Header -->
        <div class="text-center mb-8">
            <div class="flex justify-between items-center mb-4">
                <div></div>
                <div id="authButtons" class="space-x-2">
                    <a href="login.html" class="px-4 py-2 text-blue-600 border border-blue-600 rounded hover:bg-blue-50">ë¡œê·¸ì¸</a>
                    <a href="register.html" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">íšŒì›ê°€ì…</a>
                </div>
                <div id="userInfo" class="hidden space-x-2">
                    <a href="history.html" class="px-4 py-2 text-blue-600 border border-blue-600 rounded hover:bg-blue-50">
                        <i class="fas fa-history mr-1"></i>ë‚´ ì—¬í–‰
                    </a>
                    <span id="userName" class="text-gray-700"></span>
                    <button id="logoutBtn" class="px-4 py-2 text-red-600 border border-red-600 rounded hover:bg-red-50">ë¡œê·¸ì•„ì›ƒ</button>
                </div>
            </div>
            <h1 class="text-4xl font-bold text-gray-800 mb-2">ğŸ‡°ğŸ‡· ìŠ¤ë§ˆíŠ¸ í•œêµ­ ì—¬í–‰ í”Œë˜ë„ˆ</h1>
            <p class="text-gray-600">AIê°€ ì¶”ì²œí•˜ëŠ” ë§ì¶¤í˜• í•œêµ­ ì—¬í–‰ ê³„íš</p>
        </div>

        <!-- Main Form -->
        <div class="max-w-4xl mx-auto bg-white rounded-lg shadow-lg p-6 mb-8">
            <form id="travelForm" class="space-y-6">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            <i class="fas fa-map-marker-alt text-red-500"></i> ì—¬í–‰ ë„ì‹œ
                        </label>
                        <select id="city" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                            <optgroup label="íŠ¹ë³„ì‹œ">
                                <option value="Seoul">ì„œìš¸íŠ¹ë³„ì‹œ</option>
                            </optgroup>
                            <optgroup label="ê´‘ì—­ì‹œ">
                                <option value="Busan">ë¶€ì‚°ê´‘ì—­ì‹œ</option>
                                <option value="Daegu">ëŒ€êµ¬ê´‘ì—­ì‹œ</option>
                                <option value="Incheon">ì¸ì²œê´‘ì—­ì‹œ</option>
                                <option value="Gwangju">ê´‘ì£¼ê´‘ì—­ì‹œ</option>
                                <option value="Daejeon">ëŒ€ì „ê´‘ì—­ì‹œ</option>
                                <option value="Ulsan">ìš¸ì‚°ê´‘ì—­ì‹œ</option>
                            </optgroup>
                            <optgroup label="íŠ¹ë³„ìì¹˜ë„">
                                <option value="Jeju">ì œì£¼íŠ¹ë³„ìì¹˜ë„</option>
                            </optgroup>
                            <optgroup label="ê²½ê¸°ë„">
                                <option value="Suwon">ìˆ˜ì›ì‹œ</option>
                                <option value="Yongin">ìš©ì¸ì‹œ</option>
                                <option value="Seongnam">ì„±ë‚¨ì‹œ</option>
                                <option value="Goyang">ê³ ì–‘ì‹œ</option>
                            </optgroup>
                            <optgroup label="ê°•ì›ë„">
                                <option value="Chuncheon">ì¶˜ì²œì‹œ</option>
                                <option value="Gangneung">ê°•ë¦‰ì‹œ</option>
                                <option value="Sokcho">ì†ì´ˆì‹œ</option>
                            </optgroup>
                            <optgroup label="ì¶©ì²­ë¶ë„">
                                <option value="Cheongju">ì²­ì£¼ì‹œ</option>
                                <option value="Chungju">ì¶©ì£¼ì‹œ</option>
                            </optgroup>
                            <optgroup label="ì¶©ì²­ë‚¨ë„">
                                <option value="Cheonan">ì²œì•ˆì‹œ</option>
                                <option value="Gongju">ê³µì£¼ì‹œ</option>
                                <option value="Buyeo">ë¶€ì—¬êµ°</option>
                            </optgroup>
                            <optgroup label="ì „ë¼ë¶ë„">
                                <option value="Jeonju">ì „ì£¼ì‹œ</option>
                                <option value="Gunsan">êµ°ì‚°ì‹œ</option>
                            </optgroup>
                            <optgroup label="ì „ë¼ë‚¨ë„">
                                <option value="Mokpo">ëª©í¬ì‹œ</option>
                                <option value="Yeosu">ì—¬ìˆ˜ì‹œ</option>
                                <option value="Suncheon">ìˆœì²œì‹œ</option>
                            </optgroup>
                            <optgroup label="ê²½ìƒë¶ë„">
                                <option value="Pohang">í¬í•­ì‹œ</option>
                                <option value="Gyeongju">ê²½ì£¼ì‹œ</option>
                                <option value="Andong">ì•ˆë™ì‹œ</option>
                            </optgroup>
                            <optgroup label="ê²½ìƒë‚¨ë„">
                                <option value="Changwon">ì°½ì›ì‹œ</option>
                                <option value="Jinju">ì§„ì£¼ì‹œ</option>
                                <option value="Tongyeong">í†µì˜ì‹œ</option>
                                <option value="Geoje">ê±°ì œì‹œ</option>
                            </optgroup>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            <i class="fas fa-heart text-pink-500"></i> ì—¬í–‰ ìŠ¤íƒ€ì¼
                        </label>
                        <select id="travelStyle" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                            <option value="indoor_date">ğŸ’• ì‹¤ë‚´ ë°ì´íŠ¸</option>
                            <option value="outdoor_date">ğŸŒ³ ì‹¤ì™¸ ë°ì´íŠ¸</option>
                            <option value="food_tour">ğŸ½ï¸ ë§›ì§‘ íˆ¬ì–´</option>
                            <option value="culture_tour">ğŸ›ï¸ ë¬¸í™” íƒë°©</option>
                            <option value="shopping_tour">ğŸ›ï¸ ì‡¼í•‘ íˆ¬ì–´</option>
                            <option value="healing_tour">ğŸ§˜ íë§ ì—¬í–‰</option>
                            <option value="adventure_tour">ğŸ¢ ì•¡í‹°ë¹„í‹°</option>
                            <option value="night_tour">ğŸŒƒ ì•¼ê²½ íˆ¬ì–´</option>
                            <option value="family_tour">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦ ê°€ì¡± ì—¬í–‰</option>
                            <option value="custom">âœ¨ ë§ì¶¤ ì„¤ì •</option>
                        </select>
                    </div>
                </div>

                <!-- ì—¬í–‰ ê¸°ê°„ ì„¤ì • -->
                <div id="customDateSection" class="space-y-4">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                <i class="fas fa-calendar-plus text-green-500"></i> ì—¬í–‰ ì‹œì‘
                            </label>
                            <div class="grid grid-cols-2 gap-2">
                                <input type="date" id="startDate" class="p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                <input type="time" id="startTime" value="09:00" class="p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                <i class="fas fa-calendar-minus text-red-500"></i> ì—¬í–‰ ì¢…ë£Œ
                            </label>
                            <div class="grid grid-cols-2 gap-2">
                                <input type="date" id="endDate" class="p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                <input type="time" id="endTime" value="18:00" class="p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                            </div>
                        </div>
                    </div>
                    
                    <!-- ì—¬í–‰ ê¸°ê°„ í‘œì‹œ -->
                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                        <div class="flex items-center space-x-2">
                            <i class="fas fa-info-circle text-blue-500"></i>
                            <span class="text-sm font-medium text-blue-800">ì—¬í–‰ ê¸°ê°„:</span>
                            <span id="tripDuration" class="text-sm text-blue-700">ë‚ ì§œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”</span>
                        </div>
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        <i class="fas fa-home text-orange-500"></i> ì¶œë°œì§€ (ì§‘ ì£¼ì†Œ)</span>
                    </label>
                    <div class="relative">
                        <input type="text" id="startLocation" placeholder="ì§€ë„ì—ì„œ ì¶œë°œì§€ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”"
                               class="w-full p-3 border border-gray-300 rounded-lg bg-gray-50 cursor-pointer focus:ring-2 focus:ring-blue-500" readonly>
                        <button type="button" id="mapSearchBtn" class="absolute right-2 top-1/2 transform -translate-y-1/2 text-blue-500 hover:text-blue-700">
                            <i class="fas fa-map-marker-alt"></i>
                        </button>
                    </div>

                </div>

                <!-- ì§€ë„ ì„ íƒ ëª¨ë‹¬ -->
                <div id="mapModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center">
                    <div class="bg-white rounded-lg shadow-xl max-w-4xl w-full mx-4 max-h-96">
                        <div class="p-4">
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="text-lg font-bold text-gray-800">ì¶œë°œì§€ ì„ íƒ</h3>
                                <button id="closeMapModal" class="text-gray-500 hover:text-gray-700">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                            <div class="mb-3">
                                <input type="text" id="mapSearchInput" placeholder="ì£¼ì†Œë‚˜ ì¥ì†Œëª… ê²€ìƒ‰"
                                       class="w-full p-2 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500">
                            </div>
                            <div id="mapContainer" class="w-full h-80 rounded border"></div>
                            <div class="mt-3 flex justify-end space-x-2">
                                <button id="cancelMapSelection" class="px-4 py-2 text-gray-600 border rounded hover:bg-gray-50">ì·¨ì†Œ</button>
                                <button id="confirmMapSelection" class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600">ì„ íƒ ì™„ë£Œ</button>
                            </div>
                        </div>
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        <i class="fas fa-comment text-green-500"></i> ì—¬í–‰ ìš”ì²­ì‚¬í•­
                    </label>
                    <textarea id="prompt" rows="4" placeholder="ì˜ˆ: ë§›ì§‘ ìœ„ì£¼ë¡œ ê°€ì¡± ì—¬í–‰ ê³„íšì„ ì„¸ì›Œì£¼ì„¸ìš”"
                              class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"></textarea>
                </div>

                <button type="submit" id="submitBtn"
                        class="w-full bg-gradient-to-r from-blue-500 to-indigo-600 text-white py-3 px-6 rounded-lg hover:from-blue-600 hover:to-indigo-700 transition duration-300">
                    <i class="fas fa-magic mr-2"></i>
                    <span id="btnText">AI ì—¬í–‰ ê³„íš ìƒì„±</span>
                </button>
            </form>
        </div>

        <!-- Loading -->
        <div id="loading" class="hidden text-center py-8">
            <div class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-blue-500"></div>
            <p class="mt-4 text-gray-600">AIê°€ ë§ì¶¤í˜• ì—¬í–‰ ê³„íšì„ ìƒì„±í•˜ê³  ìˆìŠµë‹ˆë‹¤...</p>
        </div>

        <!-- Results -->
        <div id="results" class="hidden max-w-7xl mx-auto">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- Left Column: Timeline & Details -->
                <div class="space-y-6">
                    <!-- Timeline -->
                    <div class="bg-white rounded-lg shadow-lg p-6">
                        <h2 class="text-2xl font-bold text-gray-800 mb-4">
                            <i class="fas fa-clock text-blue-500"></i> ì‹œê°„ë³„ ì¼ì •
                        </h2>
                        <div id="timeline" class="space-y-4"></div>
                    </div>

                    <!-- Place Details -->
                    <div class="bg-white rounded-lg shadow-lg p-6">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">
                            <i class="fas fa-info-circle text-green-500"></i> ì¥ì†Œ ìƒì„¸ì •ë³´
                        </h3>
                        <div id="placeDetails" class="space-y-4"></div>
                    </div>
                </div>

                <!-- Right Column: Map & Status -->
                <div class="space-y-6">
                    <!-- Map -->
                    <div class="bg-white rounded-lg shadow-lg p-6">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">
                            <i class="fas fa-map text-red-500"></i> ìµœì  ë™ì„ 
                        </h3>
                        <div class="mb-3 flex space-x-4 text-xs">
                            <div class="flex items-center">
                                <div class="w-4 h-1 bg-blue-500 mr-1"></div>
                                <span>ğŸš‡ ëŒ€ì¤‘êµí†µ</span>
                            </div>
                            <div class="flex items-center">
                                <div class="w-4 h-1 bg-red-500 mr-1"></div>
                                <span>ğŸš— ìë™ì°¨</span>
                            </div>
                            <div class="flex items-center">
                                <div class="w-4 h-1 bg-green-500 mr-1"></div>
                                <span>ğŸš¶ ë„ë³´</span>
                            </div>
                        </div>
                        <div id="map" class="w-full h-96 rounded-lg"></div>
                    </div>

                    <!-- Weather Info -->
                    <div id="weatherInfo" class="bg-white rounded-lg shadow-lg p-6 hidden">
                        <h3 class="text-lg font-semibold text-gray-800 mb-3">
                            <i class="fas fa-cloud-sun text-blue-500"></i> í˜„ì¬ ë‚ ì”¨
                        </h3>
                        <div id="weatherContent" class="space-y-2"></div>
                    </div>

                    <!-- ì—¬í–‰ ê³„íš ì €ì¥ -->
                    <div class="bg-white rounded-lg shadow-lg p-6">
                        <h3 class="text-lg font-semibold text-gray-800 mb-3">
                            <i class="fas fa-save text-green-500"></i> ì—¬í–‰ ê³„íš ì €ì¥
                        </h3>
                        <div class="space-y-3">
                            <button id="savePlanBtn" class="w-full bg-green-500 text-white py-2 rounded hover:bg-green-600">
                                <i class="fas fa-bookmark mr-2"></i>ë‚´ ì—¬í–‰ ê³„íšì— ì €ì¥
                            </button>
                            <button id="saveNotionBtn" class="w-full bg-purple-500 text-white py-2 rounded hover:bg-purple-600">
                                <i class="fas fa-database mr-2"></i>Notionì— ì €ì¥
                            </button>
                        </div>
                        <div id="saveResult" class="mt-3 hidden"></div>
                    </div>
                    
                    <!-- ì˜ˆì‚° ê³„ì‚°ê¸° -->
                    <div class="bg-white rounded-lg shadow-lg p-6">
                        <h3 class="text-lg font-semibold text-gray-800 mb-3">
                            <i class="fas fa-calculator text-orange-500"></i> ì˜ˆì‚° ê³„ì‚°
                        </h3>
                        <div class="space-y-2">
                            <select id="budgetStyle" class="w-full p-2 border rounded">
                                <option value="budget">ì ˆì•½í˜•</option>
                                <option value="moderate" selected>ë³´í†µ</option>
                                <option value="luxury">ëŸ­ì…”ë¦¬</option>
                            </select>
                            <button id="calculateBudgetBtn" class="w-full bg-orange-500 text-white py-2 rounded hover:bg-orange-600">
                                ì˜ˆì‚° ê³„ì‚°í•˜ê¸°
                            </button>
                        </div>
                        <div id="budgetResult" class="mt-3 hidden"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Toast Notifications -->
        <div id="toast" class="fixed top-4 right-4 z-50 hidden">
            <div class="bg-white border-l-4 border-green-500 rounded-lg shadow-lg p-4 max-w-sm">
                <div class="flex items-center">
                    <i id="toastIcon" class="fas fa-check-circle text-green-500 mr-3"></i>
                    <span id="toastMessage" class="text-gray-800"></span>
                </div>
            </div>
        </div>

        <!-- Place Modal -->
        <div id="placeModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center">
            <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full mx-4 max-h-96 overflow-y-auto">
                <div class="p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h3 id="modalTitle" class="text-xl font-bold text-gray-800"></h3>
                        <button id="closeModal" class="text-gray-500 hover:text-gray-700">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div id="modalContent" class="space-y-4"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        console.log('Main page script loaded');
        
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM ready');
            
            // ì‚¬ìš©ì ì¸ì¦ ìƒíƒœ í™•ì¸
            checkAuthStatus();
            
            // ì˜¤ëŠ˜ ë‚ ì§œ ì„¤ì •
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('startDate').value = today;
            document.getElementById('endDate').value = today;
            
            // Google Maps ì´ˆê¸°í™”
            if (typeof google !== 'undefined') {
                initMap();
            }
            
            // ì§€ë„ ëª¨ë‹¬ ì´ë²¤íŠ¸ ë“±ë¡
            setupMapModalEvents();
            
            // ì¶œë°œì§€ ì…ë ¥ í•„ë“œ í´ë¦­ ì‹œ ì§€ë„ ëª¨ë‹¬ ì—´ê¸°
            const startLocationInput = document.getElementById('startLocation');
            if (startLocationInput) {
                startLocationInput.addEventListener('click', function() {
                    document.getElementById('mapModal').classList.remove('hidden');
                    setTimeout(() => {
                        if (!mapModal) {
                            initMapModal();
                        }
                    }, 100);
                });
            }
            
            // í¼ ì´ë²¤íŠ¸ ë“±ë¡
            const form = document.getElementById('travelForm');
            if (form) {
                console.log('Form found');
                form.onsubmit = async function(e) {
                    e.preventDefault();
                    console.log('Form submitted');
                    
                    const city = document.getElementById('city').value;
                    const prompt = document.getElementById('prompt').value;
                    const startLocation = document.getElementById('startLocation').value;
                    
                    if (!startLocation.trim()) {
                        alert('ì¶œë°œì§€ë¥¼ ì§€ë„ì—ì„œ ì„ íƒí•´ì£¼ì„¸ìš”');
                        return;
                    }
                    
                    if (!prompt.trim()) {
                        alert('ì—¬í–‰ ìš”ì²­ì‚¬í•­ì„ ì…ë ¥í•´ì£¼ì„¸ìš”');
                        return;
                    }
                    
                    // ë¡œë”© í‘œì‹œ
                    document.getElementById('loading').classList.remove('hidden');
                    document.getElementById('results').classList.add('hidden');
                    document.getElementById('submitBtn').disabled = true;
                    document.getElementById('btnText').textContent = 'ìƒì„± ì¤‘...';
                    
                    try {
                        const startDate = document.getElementById('startDate').value;
                        const endDate = document.getElementById('endDate').value;
                        const startTime = document.getElementById('startTime').value;
                        const endTime = document.getElementById('endTime').value;
                        
                        const response = await fetch('/api/travel/plan', {
                            method: 'POST',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify({
                                prompt: prompt,
                                preferences: {
                                    city: city,
                                    start_location: startLocation,
                                    start_date: startDate,
                                    end_date: endDate,
                                    start_time: startTime,
                                    end_time: endTime
                                }
                            })
                        });
                        
                        const data = await response.json();
                        console.log('API Response:', data);
                        
                        // ë¡œë”© ìˆ¨ê¸°ê¸°
                        document.getElementById('loading').classList.add('hidden');
                        document.getElementById('submitBtn').disabled = false;
                        document.getElementById('btnText').textContent = 'AI ì—¬í–‰ ê³„íš ìƒì„±';
                        
                        // ê²°ê³¼ í˜ì´ì§€ë¡œ ì´ë™
                        const encodedData = encodeURIComponent(JSON.stringify(data));
                        window.location.href = `/results.html?data=${encodedData}`;
                        
                    } catch (error) {
                        console.error('Error:', error);
                        alert('ì˜¤ë¥˜: ' + error.message);
                        
                        // ë¡œë”© ìˆ¨ê¸°ê¸°
                        document.getElementById('loading').classList.add('hidden');
                        document.getElementById('submitBtn').disabled = false;
                        document.getElementById('btnText').textContent = 'AI ì—¬í–‰ ê³„íš ìƒì„±';
                    }
                };
            }
        });
        
        let map, directionsService, directionsRenderer;
        let mapModal, mapSearchInput, autocomplete, selectedPlace;
        
        function initMap() {
            map = new google.maps.Map(document.getElementById('map'), {
                zoom: 13,
                center: { lat: 37.5665, lng: 126.9780 }
            });
            directionsService = new google.maps.DirectionsService();
            directionsRenderer = new google.maps.DirectionsRenderer();
            directionsRenderer.setMap(map);
            
            // ì¶œë°œì§€ ì…ë ¥ í•„ë“œì— Autocomplete ì¶”ê°€
            initPlacesAutocomplete();
        }
        
        function initPlacesAutocomplete() {
            // ìë™ì™„ì„± ê¸°ëŠ¥ ë¹„í™œì„±í™” - ì§€ë„ì—ì„œë§Œ ì„ íƒ ê°€ëŠ¥
        }
        
        function initMapModal() {
            mapModal = new google.maps.Map(document.getElementById('mapContainer'), {
                zoom: 13,
                center: { lat: 37.5665, lng: 126.9780 }
            });
            
            // ì§€ë„ ê²€ìƒ‰ Autocomplete
            mapSearchInput = document.getElementById('mapSearchInput');
            const mapAutocomplete = new google.maps.places.Autocomplete(mapSearchInput, {
                componentRestrictions: { country: 'kr' },
                fields: ['place_id', 'geometry', 'name', 'formatted_address']
            });
            
            let marker;
            
            mapAutocomplete.addListener('place_changed', () => {
                const place = mapAutocomplete.getPlace();
                if (place.geometry) {
                    // ê¸°ì¡´ ë§ˆì»¤ ì œê±°
                    if (marker) marker.setMap(null);
                    
                    // ìƒˆ ë§ˆì»¤ ì¶”ê°€
                    marker = new google.maps.Marker({
                        position: place.geometry.location,
                        map: mapModal,
                        title: place.name
                    });
                    
                    // ì§€ë„ ì¤‘ì‹¬ ì´ë™
                    mapModal.setCenter(place.geometry.location);
                    mapModal.setZoom(15);
                    
                    // ì„ íƒëœ ì¥ì†Œ ì €ì¥
                    selectedPlace = {
                        name: place.name,
                        address: place.formatted_address,
                        lat: place.geometry.location.lat(),
                        lng: place.geometry.location.lng()
                    };
                }
            });
            
            // ì§€ë„ í´ë¦­ ì´ë²¤íŠ¸
            mapModal.addListener('click', (event) => {
                // ê¸°ì¡´ ë§ˆì»¤ ì œê±°
                if (marker) marker.setMap(null);
                
                // ìƒˆ ë§ˆì»¤ ì¶”ê°€
                marker = new google.maps.Marker({
                    position: event.latLng,
                    map: mapModal,
                    title: 'ì„ íƒëœ ìœ„ì¹˜'
                });
                
                // ì„ íƒëœ ìœ„ì¹˜ ì €ì¥
                selectedPlace = {
                    name: 'ì„ íƒëœ ìœ„ì¹˜',
                    address: `ìœ„ë„: ${event.latLng.lat().toFixed(6)}, ê²½ë„: ${event.latLng.lng().toFixed(6)}`,
                    lat: event.latLng.lat(),
                    lng: event.latLng.lng()
                };
            });
        }
        
        function displayResults(data) {
            document.getElementById('results').classList.remove('hidden');
            
            // ë‚ ì”¨ ì •ë³´ í‘œì‹œ
            if (data.weather_info) {
                displayWeatherInfo(data.weather_info);
            }
            
            // Google Maps ì´ˆê¸°í™”
            setTimeout(() => {
                if (!map) {
                    initMap();
                }
                // ê²½ë¡œ í‘œì‹œ
                if (data.itinerary && data.itinerary.length > 0) {
                    displayRouteWithTransportation(data.itinerary);
                }
            }, 100);
            
            // íƒ€ì„ë¼ì¸ í‘œì‹œ
            const timeline = document.getElementById('timeline');
            timeline.innerHTML = '';
            
            if (data.itinerary) {
                data.itinerary.forEach((item, index) => {
                    const div = document.createElement('div');
                    div.className = 'p-4 bg-gray-50 rounded-lg mb-4';
                    div.innerHTML = `
                        <div class="flex items-center space-x-2 mb-2">
                            <span class="bg-blue-500 text-white rounded-full w-6 h-6 flex items-center justify-center text-sm">${index + 1}</span>
                            <span class="font-semibold text-blue-600">${item.time || 'ì‹œê°„ ë¯¸ì •'}</span>
                            <span class="text-sm text-gray-500">â€¢ ${item.duration || '30ë¶„'}</span>
                        </div>
                        <h4 class="font-medium text-gray-800 mb-1">${item.name || item.activity || 'í™œë™'}</h4>
                        <p class="text-sm text-gray-600 mb-2">${item.description || ''}</p>
                        <div class="text-xs text-gray-500">
                            <span><i class="fas fa-map-marker-alt"></i> ${item.location || item.address || ''}</span>
                            ${item.price ? `<span class="ml-4"><i class="fas fa-won-sign"></i> ${item.price}</span>` : ''}
                        </div>
                    `;
                    timeline.appendChild(div);
                });
            }
            
            // ì¥ì†Œ ìƒì„¸ì •ë³´ í‘œì‹œ
            displayPlaceDetails(data.itinerary || []);
            
            // Notion ìƒíƒœ í‘œì‹œ
            const notionResult = document.getElementById('notionResult');
            if (data.notion_saved) {
                notionResult.innerHTML = `
                    <i class="fas fa-check-circle text-green-500 text-xl"></i>
                    <span class="text-green-700">Notion ì €ì¥ ì™„ë£Œ!</span>
                    ${data.notion_url ? `<a href="${data.notion_url}" target="_blank" class="text-blue-500 hover:underline ml-2">
                        <i class="fas fa-external-link-alt"></i> ë³´ê¸°
                    </a>` : ''}
                `;
            } else {
                notionResult.innerHTML = `
                    <i class="fas fa-exclamation-circle text-red-500 text-xl"></i>
                    <span class="text-red-700">Notion ì €ì¥ ì‹¤íŒ¨</span>
                `;
            }
        }
        
        function displayWeatherInfo(weatherInfo) {
            const weatherDiv = document.getElementById('weatherInfo');
            const weatherContent = document.getElementById('weatherContent');
            
            const weatherIcon = getWeatherIcon(weatherInfo.condition);
            const tempColor = weatherInfo.temperature > 25 ? 'text-red-500' : 
                             weatherInfo.temperature < 10 ? 'text-blue-500' : 'text-green-500';
            
            weatherContent.innerHTML = `
                <div class="flex items-center justify-between mb-3">
                    <div class="flex items-center space-x-2">
                        <span class="text-2xl">${weatherIcon}</span>
                        <span class="text-lg font-medium">${weatherInfo.condition}</span>
                    </div>
                    <span class="text-2xl font-bold ${tempColor}">${weatherInfo.temperature}Â°C</span>
                </div>
                <div class="grid grid-cols-2 gap-2 text-sm text-gray-600">
                    <div><i class="fas fa-thermometer-half"></i> ì²´ê°: ${weatherInfo.feels_like}Â°C</div>
                    <div><i class="fas fa-tint"></i> ìŠµë„: ${weatherInfo.humidity}%</div>
                    <div><i class="fas fa-wind"></i> ë°”ëŒ: ${weatherInfo.wind_speed}m/s</div>
                    <div><i class="fas fa-eye"></i> ê°€ì‹œê±°ë¦¬: ${weatherInfo.visibility}km</div>
                </div>
                ${weatherInfo.rain_probability > 0 ? `
                    <div class="mt-3 p-2 bg-blue-50 rounded">
                        <span class="text-sm text-blue-700">
                            <i class="fas fa-umbrella"></i> ê°•ìˆ˜í™•ë¥ : ${weatherInfo.rain_probability}%
                        </span>
                    </div>
                ` : ''}
                <div class="mt-3 p-2 bg-green-50 rounded">
                    <span class="text-sm text-green-700">
                        <i class="fas fa-lightbulb"></i> ${weatherInfo.recommendation}
                    </span>
                </div>
            `;
            
            weatherDiv.classList.remove('hidden');
        }
        
        function getWeatherIcon(condition) {
            const icons = {
                'ë§‘ìŒ': 'â˜€ï¸',
                'êµ¬ë¦„ì¡°ê¸ˆ': 'ğŸŒ¤ï¸', 
                'êµ¬ë¦„ë§ìŒ': 'â˜ï¸',
                'íë¦¼': 'â˜ï¸',
                'ë¹„': 'ğŸŒ§ï¸',
                'ì†Œë‚˜ê¸°': 'ğŸŒ¦ï¸',
                'ëˆˆ': 'â„ï¸',
                'ì•ˆê°œ': 'ğŸŒ«ï¸'
            };
            
            for (const [key, icon] of Object.entries(icons)) {
                if (condition.includes(key)) {
                    return icon;
                }
            }
            return 'ğŸŒ¤ï¸';
        }
        
        function displayPlaceDetails(itinerary) {
            const placeDetails = document.getElementById('placeDetails');
            placeDetails.innerHTML = '';
            
            itinerary.forEach(item => {
                const placeDiv = document.createElement('div');
                placeDiv.className = 'border rounded-lg p-4 hover:shadow-md transition-shadow';
                placeDiv.innerHTML = `
                    <div class="flex items-start justify-between mb-2">
                        <h4 class="font-semibold text-gray-800">${item.place_name || item.name || item.activity}</h4>
                        <div class="flex space-x-2">
                            <span class="px-2 py-1 text-xs rounded-full ${
                                item.verified ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800'
                            }">
                                ${item.verified ? 'âœ“ í™•ì¸ë¨' : 'âš  ë¯¸í™•ì¸'}
                            </span>
                            ${item.quality_score > 0 ? `
                                <span class="px-2 py-1 text-xs rounded-full ${
                                    item.quality_score >= 4.0 ? 'bg-blue-100 text-blue-800' :
                                    item.quality_score >= 3.0 ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'
                                }">
                                    í’ˆì§ˆ: ${item.quality_score.toFixed(1)}/5.0
                                </span>
                            ` : ''}
                        </div>
                    </div>
                    <p class="text-sm text-gray-600 mb-2">${item.description || ''}</p>
                    <div class="flex items-center space-x-4 text-xs text-gray-500 mb-2">
                        <span><i class="fas fa-star text-yellow-400"></i> ${item.rating || 'N/A'}/5</span>
                        <span><i class="fas fa-users"></i> ë¦¬ë·° ${item.blog_reviews ? item.blog_reviews.length : 0}ê°œ</span>
                        ${item.phone ? `<span><i class="fas fa-phone"></i> ${item.phone}</span>` : ''}
                        <span><i class="fas fa-clock"></i> ${item.opening_hours ? item.opening_hours.join(', ') : '09:00-21:00'}</span>
                    </div>
                    ${item.blog_reviews && item.blog_reviews.length > 0 ? `
                        <div class="mt-3">
                            <p class="text-xs font-medium text-gray-700 mb-1">ê´€ë ¨ ë¦¬ë·°:</p>
                            <div class="space-y-1">
                                ${item.blog_reviews.slice(0, 3).map(blog => `
                                    <a href="${blog.link}" target="_blank" class="block text-xs text-blue-600 hover:underline">
                                        <i class="fas fa-external-link-alt mr-1"></i>${blog.title}
                                    </a>
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}
                    ${item.blog_contents && item.blog_contents.length > 0 ? `
                        <div class="mt-3 space-y-2">
                            ${item.blog_contents.map(content => `
                                <div class="p-2 bg-yellow-50 rounded">
                                    <p class="text-xs font-medium text-gray-700 mb-1">ë¸”ë¡œê·¸ í›„ê¸° ë‚´ìš©:</p>
                                    <p class="text-xs text-gray-600 mb-2">${content.summary || content.content || 'í›„ê¸° ë‚´ìš©ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...'}</p>
                                    ${content.keywords && content.keywords.length > 0 ? `
                                        <div class="flex flex-wrap gap-1">
                                            ${content.keywords.map(keyword => `
                                                <span class="inline-block px-2 py-0.5 text-xs bg-blue-100 text-blue-800 rounded">${keyword}</span>
                                            `).join('')}
                                        </div>
                                    ` : ''}
                                    ${content.rating ? `
                                        <div class="mt-1 text-xs text-gray-500">
                                            <i class="fas fa-star text-yellow-400"></i> ë¸”ë¡œê·¸ í‰ì : ${content.rating}/5
                                        </div>
                                    ` : ''}
                                    ${content.url ? `
                                        <div class="mt-1">
                                            <a href="${content.url}" target="_blank" class="text-xs text-blue-600 hover:underline">
                                                <i class="fas fa-external-link-alt mr-1"></i>ì›ë³¸ ë¸”ë¡œê·¸ ë³´ê¸°
                                            </a>
                                        </div>
                                    ` : ''}
                                </div>
                            `).join('')}
                        </div>
                    ` : ''}
                `;
                placeDetails.appendChild(placeDiv);
            });
        }
        
        function setupMapModalEvents() {
            // ì§€ë„ ê²€ìƒ‰ ë²„íŠ¼ í´ë¦­
            document.getElementById('mapSearchBtn').addEventListener('click', () => {
                document.getElementById('mapModal').classList.remove('hidden');
                // ì§€ë„ ëª¨ë‹¬ ì´ˆê¸°í™”
                setTimeout(() => {
                    if (!mapModal) {
                        initMapModal();
                    }
                }, 100);
            });
            
            // ëª¨ë‹¬ ë‹«ê¸°
            document.getElementById('closeMapModal').addEventListener('click', () => {
                document.getElementById('mapModal').classList.add('hidden');
            });
            
            // ì·¨ì†Œ ë²„íŠ¼
            document.getElementById('cancelMapSelection').addEventListener('click', () => {
                document.getElementById('mapModal').classList.add('hidden');
            });
            
            // ì„ íƒ ì™„ë£Œ ë²„íŠ¼
            document.getElementById('confirmMapSelection').addEventListener('click', () => {
                if (selectedPlace) {
                    document.getElementById('startLocation').value = selectedPlace.address;
                    document.getElementById('mapModal').classList.add('hidden');
                } else {
                    alert('ìœ„ì¹˜ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
                }
            });
        }
        
        function displayRouteWithTransportation(itinerary) {
            const startLocation = selectedPlace ? selectedPlace.address : document.getElementById('startLocation').value;
            if (!startLocation.trim()) {
                // ì¶œë°œì§€ê°€ ì—†ìœ¼ë©´ ì¼ë°˜ ë§ˆì»¤ë§Œ í‘œì‹œ
                displayMarkersOnly(itinerary);
                return;
            }
            
            // ì¶œë°œì§€ì—ì„œ ì²« ë²ˆì§¸ ì¥ì†Œë¡œì˜ ê²½ë¡œ í‘œì‹œ
            if (itinerary.length > 0) {
                const destination = itinerary[0];
                displayMultipleRoutes(startLocation, destination);
            }
            
            // ëª¨ë“  ì¥ì†Œì— ë§ˆì»¤ í‘œì‹œ
            displayMarkersOnly(itinerary);
        }
        
        function displayMultipleRoutes(start, destination) {
            const modes = [
                { mode: google.maps.TravelMode.TRANSIT, color: '#4285F4', name: 'ëŒ€ì¤‘êµí†µ' },
                { mode: google.maps.TravelMode.DRIVING, color: '#EA4335', name: 'ìë™ì°¨' },
                { mode: google.maps.TravelMode.WALKING, color: '#34A853', name: 'ë„ë³´' }
            ];
            
            modes.forEach((transport, index) => {
                const request = {
                    origin: start,
                    destination: `${destination.address || destination.location}`,
                    travelMode: transport.mode
                };
                
                directionsService.route(request, (result, status) => {
                    if (status === 'OK') {
                        const renderer = new google.maps.DirectionsRenderer({
                            directions: result,
                            routeIndex: 0,
                            polylineOptions: {
                                strokeColor: transport.color,
                                strokeWeight: 4,
                                strokeOpacity: 0.7
                            },
                            suppressMarkers: index > 0 // ì²« ë²ˆì§¸ë§Œ ë§ˆì»¤ í‘œì‹œ
                        });
                        renderer.setMap(map);
                        
                        // ê²½ë¡œ ì •ë³´ í‘œì‹œ
                        const route = result.routes[0];
                        const leg = route.legs[0];
                        console.log(`${transport.name}: ${leg.distance.text}, ${leg.duration.text}`);
                    }
                });
            });
        }
        
        function displayMarkersOnly(itinerary) {
            itinerary.forEach((item, index) => {
                const marker = new google.maps.Marker({
                    position: { lat: item.lat || 37.5665, lng: item.lng || 126.9780 },
                    map: map,
                    title: item.place_name || item.name || item.activity,
                    label: (index + 1).toString()
                });
                
                const infoWindow = new google.maps.InfoWindow({
                    content: `
                        <div>
                            <h4><strong>${item.place_name || item.name || item.activity}</strong></h4>
                            <p>${item.description || ''}</p>
                            <p><i class="fas fa-map-marker-alt"></i> ${item.address || item.location || ''}</p>
                            ${item.rating ? `<p><i class="fas fa-star"></i> ${item.rating}/5</p>` : ''}
                        </div>
                    `
                });
                
                marker.addListener('click', () => {
                    infoWindow.open(map, marker);
                });
            });
        }
        
        // ì‚¬ìš©ì ì¸ì¦ ê´€ë ¨ í•¨ìˆ˜
        let currentTravelPlan = null;
        
        function checkAuthStatus() {
            const token = localStorage.getItem('access_token');
            if (token) {
                // ë¡œê·¸ì¸ ìƒíƒœ
                document.getElementById('authButtons').classList.add('hidden');
                document.getElementById('userInfo').classList.remove('hidden');
                document.getElementById('userName').textContent = 'ì‚¬ìš©ì';
                
                // ë¡œê·¸ì•„ì›ƒ ì´ë²¤íŠ¸
                document.getElementById('logoutBtn').onclick = function() {
                    localStorage.removeItem('access_token');
                    location.reload();
                };
            }
        }
        
        // ì—¬í–‰ ê³„íš ì €ì¥ ê¸°ëŠ¥
        function setupSaveFeatures() {
            // ë‚´ ì—¬í–‰ ê³„íšì— ì €ì¥
            document.getElementById('savePlanBtn').onclick = async function() {
                if (!currentTravelPlan) {
                    alert('ì €ì¥í•  ì—¬í–‰ ê³„íšì´ ì—†ìŠµë‹ˆë‹¤.');
                    return;
                }
                
                const token = localStorage.getItem('access_token');
                if (!token) {
                    alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
                    window.location.href = 'login.html';
                    return;
                }
                
                try {
                    const response = await fetch('/api/users/travel-plans', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify({
                            title: currentTravelPlan.title,
                            city: currentTravelPlan.preferences?.city || 'Seoul',
                            itinerary_json: JSON.stringify(currentTravelPlan.itinerary),
                            total_cost: currentTravelPlan.total_cost?.amount || 0
                        })
                    });
                    
                    if (response.ok) {
                        showSaveResult('ë‚´ ì—¬í–‰ ê³„íšì— ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
                    } else {
                        showSaveResult('ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
                    }
                } catch (error) {
                    showSaveResult('ì˜¤ë¥˜: ' + error.message, 'error');
                }
            };
            
            // Notionì— ì €ì¥
            document.getElementById('saveNotionBtn').onclick = async function() {
                if (!currentTravelPlan) {
                    alert('ì €ì¥í•  ì—¬í–‰ ê³„íšì´ ì—†ìŠµë‹ˆë‹¤.');
                    return;
                }
                
                try {
                    const response = await fetch('/api/travel/save-notion', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify(currentTravelPlan)
                    });
                    
                    const result = await response.json();
                    if (result.success) {
                        showSaveResult(`Notionì— ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤! <a href="${result.url}" target="_blank" class="text-blue-500 hover:underline">ë³´ê¸°</a>`, 'success');
                    } else {
                        showSaveResult('Notion ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
                    }
                } catch (error) {
                    showSaveResult('ì˜¤ë¥˜: ' + error.message, 'error');
                }
            };
            
            // ì˜ˆì‚° ê³„ì‚°
            document.getElementById('calculateBudgetBtn').onclick = async function() {
                if (!currentTravelPlan || !currentTravelPlan.itinerary) {
                    alert('ê³„ì‚°í•  ì—¬í–‰ ê³„íšì´ ì—†ìŠµë‹ˆë‹¤.');
                    return;
                }
                
                const budgetStyle = document.getElementById('budgetStyle').value;
                
                try {
                    const response = await fetch('/api/users/calculate-budget', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({
                            itinerary: currentTravelPlan.itinerary,
                            travel_style: budgetStyle
                        })
                    });
                    
                    const budget = await response.json();
                    showBudgetResult(budget);
                } catch (error) {
                    alert('ì˜ˆì‚° ê³„ì‚° ì˜¤ë¥˜: ' + error.message);
                }
            };
        }
        
        function showSaveResult(message, type) {
            const saveResult = document.getElementById('saveResult');
            saveResult.className = `mt-3 p-2 rounded ${type === 'success' ? 'bg-green-50 text-green-700' : 'bg-red-50 text-red-700'}`;
            saveResult.innerHTML = message;
            saveResult.classList.remove('hidden');
        }
        
        function showBudgetResult(budget) {
            const budgetResult = document.getElementById('budgetResult');
            budgetResult.innerHTML = `
                <div class="p-3 bg-orange-50 rounded">
                    <h4 class="font-semibold text-orange-800 mb-2">ì˜ˆìƒ ë¹„ìš©: ${budget.total_cost.toLocaleString()}ì›</h4>
                    <div class="text-sm text-orange-700 space-y-1">
                        <div>êµí†µë¹„: ${budget.breakdown.transportation.toLocaleString()}ì›</div>
                        <div>ìŒì‹ë¹„: ${budget.breakdown.food.toLocaleString()}ì›</div>
                        <div>ê´€ê´‘ë¹„: ${budget.breakdown.attractions.toLocaleString()}ì›</div>
                        <div>ìˆ™ë°•ë¹„: ${budget.breakdown.accommodation.toLocaleString()}ì›</div>
                        <div>ê¸°íƒ€: ${budget.breakdown.miscellaneous.toLocaleString()}ì›</div>
                    </div>
                    ${budget.recommendations ? `
                        <div class="mt-2 text-xs text-orange-600">
                            ${budget.recommendations.slice(0, 3).map(rec => `<div>â€¢ ${rec}</div>`).join('')}
                        </div>
                    ` : ''}
                </div>
            `;
            budgetResult.classList.remove('hidden');
        }
        
        // ê²°ê³¼ í‘œì‹œ ì‹œ ì €ì¥ ê¸°ëŠ¥ í™œì„±í™”
        function displayResults(data) {
            currentTravelPlan = data;
            setupSaveFeatures();
            
            // ê¸°ì¡´ displayResults ì½”ë“œ...
            document.getElementById('results').classList.remove('hidden');
            
            // ë‚ ì”¨ ì •ë³´ í‘œì‹œ
            if (data.weather_info) {
                displayWeatherInfo(data.weather_info);
            }
            
            // ë‚˜ë¨¸ì§€ ì½”ë“œëŠ” ê¸°ì¡´ê³¼ ë™ì¼...
        }
    </script>
</body>
</html>